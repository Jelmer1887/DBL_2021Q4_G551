var FileInputComponent_1;
import { __decorate, __metadata } from "tslib";
import { ChangeDetectionStrategy, Component, ElementRef, Input, ViewChild, ViewEncapsulation } from '@angular/core';
import { ControlBase } from '../control-base';
import { DefaultValueAccessor } from '../../helper/default-value-accessor';
import { TypeAlias } from '../../helper/type-alias';
import { ObjectHelper } from '../../helper/object-helper';
let FileInputComponent = FileInputComponent_1 = class FileInputComponent extends ControlBase {
    constructor() {
        super(...arguments);
        this.multiple = false;
        this.accept = '';
        this.read = '';
        this.drop = false;
    }
    createControl() {
        return new Promise((complete) => {
            const originalElement = $(this.input.nativeElement);
            ObjectHelper.hide(originalElement);
            if (this.clonedElement) {
                this.clonedElement.parent().remove();
            }
            this.clonedElement = originalElement.clone();
            ObjectHelper.show(this.clonedElement);
            originalElement.parent().append(this.clonedElement);
            this.fileInput = this.clonedElement.file().data('file');
            if (this.drop) {
                if (this.buttonTitle) {
                    const captionElement = this.clonedElement.closest('label.drop-zone').find('span.caption');
                    captionElement.html(this.buttonTitle);
                }
                if (this.infoText) {
                    this.updateInfoText();
                }
            }
            this.fileInput.options.onSelect = (files) => {
                if (this.multiple) {
                    const result = [];
                    for (let i = 0; i < files.length; i++) {
                        result.push(files[i]);
                    }
                    if (this.read) {
                        this.readFiles(files);
                    }
                    else {
                        this.changeValue(result);
                    }
                }
                else {
                    if (this.read) {
                        this.readFiles(files);
                    }
                    else {
                        this.changeValue(files[0]);
                    }
                }
                if (this.drop && this.infoText) {
                    this.updateInfoText();
                }
            };
            this.clonedElement.one('blur', () => {
                this.touchCallback();
            });
            complete();
        });
    }
    readFiles(files) {
        const fileLoadPromises = [];
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const loadPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    resolve({ content: reader.result, file: file });
                };
                switch (this.read) {
                    case 'arrayBuffer':
                        reader.readAsArrayBuffer(file);
                        break;
                    case 'binaryString':
                        reader.readAsBinaryString(file);
                        break;
                    case 'dataUrl':
                        reader.readAsDataURL(file);
                        break;
                    case 'text':
                    default:
                        reader.readAsText(file);
                        break;
                }
            });
            fileLoadPromises.push(loadPromise);
        }
        Promise.all(fileLoadPromises).then((fileEntries) => {
            if (this.multiple) {
                this.changeValue(fileEntries);
            }
            else {
                this.changeValue(fileEntries[0]);
            }
        });
    }
    disable(disabled) {
        if (disabled) {
            this.fileInput.disable();
        }
        else {
            this.fileInput.enable();
        }
    }
    newValue() {
        if (!this.fileInput || this.drop || this.read || !this.innerValue) {
            return;
        }
        let name;
        if (this.innerValue instanceof Array) {
            name = this.innerValue.map((v) => {
                if (v instanceof File) {
                    return v.name;
                }
                else {
                    return v.file.name;
                }
            }).join(', ');
        }
        else {
            name = this.innerValue instanceof File ? this.innerValue.name : this.innerValue.file.name;
        }
        this.clonedElement.parent().find('span.caption').html(name);
    }
    newClassValue(newClasses, oldClasses) {
        if (this.clonedElement) {
            const target = this.clonedElement.parent();
            oldClasses.forEach((cls) => {
                target.removeClass(cls);
            });
            newClasses.forEach((cls) => {
                target.addClass(cls);
            });
        }
    }
    updateInfoText() {
        const infoTextContent = this.infoText
            .split('{0}')
            .join(this.innerValue instanceof Array ? `${this.innerValue.length}` : this.innerValue ? '1' : '0');
        const infoTextElement = this.clonedElement.closest('label.drop-zone').find('span.files');
        infoTextElement.html(infoTextContent);
    }
};
__decorate([
    Input('multiple'),
    __metadata("design:type", Object)
], FileInputComponent.prototype, "multiple", void 0);
__decorate([
    Input('accept'),
    __metadata("design:type", Object)
], FileInputComponent.prototype, "accept", void 0);
__decorate([
    Input('read'),
    __metadata("design:type", String)
], FileInputComponent.prototype, "read", void 0);
__decorate([
    Input('prepend'),
    __metadata("design:type", String)
], FileInputComponent.prototype, "prepend", void 0);
__decorate([
    Input('button-title'),
    __metadata("design:type", String)
], FileInputComponent.prototype, "buttonTitle", void 0);
__decorate([
    Input('info-text'),
    __metadata("design:type", String)
], FileInputComponent.prototype, "infoText", void 0);
__decorate([
    Input('drop'),
    __metadata("design:type", Object)
], FileInputComponent.prototype, "drop", void 0);
__decorate([
    Input('cls-component'),
    __metadata("design:type", String)
], FileInputComponent.prototype, "clsComponent", void 0);
__decorate([
    Input('cls-caption'),
    __metadata("design:type", String)
], FileInputComponent.prototype, "clsCaption", void 0);
__decorate([
    Input('cls-prepend'),
    __metadata("design:type", String)
], FileInputComponent.prototype, "clsPrepend", void 0);
__decorate([
    Input('cls-button'),
    __metadata("design:type", String)
], FileInputComponent.prototype, "clsButton", void 0);
__decorate([
    ViewChild('input', { static: true }),
    __metadata("design:type", ElementRef)
], FileInputComponent.prototype, "input", void 0);
FileInputComponent = FileInputComponent_1 = __decorate([
    Component({
        selector: 'm4-file-input',
        template: "<input type=\"file\" #input\r\n\r\n\r\n       [accept]=\"accept\"\r\n       [multiple]=\"multiple\"\r\n       [attr.data-prepend]=\"prepend\"\r\n       [attr.data-button-title]=\"buttonTitle\"\r\n       [attr.data-mode]=\"drop === true ? 'drop' : null\"\r\n\r\n       [attr.data-cls-component]=\"clsComponent\"\r\n       [attr.data-cls-caption]=\"clsCaption\"\r\n       [attr.data-cls-prepend]=\"clsPrepend\"\r\n       [attr.data-cls-button]=\"clsButton\">\r\n",
        providers: [DefaultValueAccessor.get(FileInputComponent_1), TypeAlias.get(FileInputComponent_1)],
        changeDetection: ChangeDetectionStrategy.OnPush,
        encapsulation: ViewEncapsulation.None,
        styles: [".drop-zone.primary{outline-color:#0366d6}.drop-zone.secondary{outline-color:#607d8b}.drop-zone.success{outline-color:#60a917}.drop-zone.alert{outline-color:#ce352c}.drop-zone.warning{outline-color:#ff9447}.drop-zone.yellow{outline-color:#ffe484}.drop-zone.info{outline-color:#5ebdec}.drop-zone.dark{outline-color:#505050}.drop-zone.light{outline-color:#f8f8f8}"]
    })
], FileInputComponent);
export { FileInputComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1pbnB1dC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1tZXRybzQvIiwic291cmNlcyI6WyJsaWIvZm9ybS9maWxlLWlucHV0L2ZpbGUtaW5wdXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFDLHVCQUF1QixFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNsSCxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDNUMsT0FBTyxFQUFDLG9CQUFvQixFQUFDLE1BQU0scUNBQXFDLENBQUM7QUFDekUsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLHlCQUF5QixDQUFDO0FBQ2xELE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQWtCeEQsSUFBYSxrQkFBa0IsMEJBQS9CLE1BQWEsa0JBQW1CLFNBQVEsV0FBb0Q7SUFBNUY7O1FBRXFCLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFDbkIsV0FBTSxHQUFHLEVBQUUsQ0FBQztRQUNkLFNBQUksR0FBcUIsRUFBRSxDQUFDO1FBSzVCLFNBQUksR0FBRyxLQUFLLENBQUM7SUF1SzlCLENBQUM7SUE1SkMsYUFBYTtRQUNYLE9BQU8sSUFBSSxPQUFPLENBQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUNwQyxNQUFNLGVBQWUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUNwRCxZQUFZLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBRW5DLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtnQkFDdEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQzthQUN0QztZQUVELElBQUksQ0FBQyxhQUFhLEdBQUcsZUFBZSxDQUFDLEtBQUssRUFB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LGtCQUFrQjtJQVI5QixTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsZUFBZTtRQUN6Qix3ZEFBMEM7UUFFMUMsU0FBUyxFQUFFLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLG9CQUFrQixDQUFDLEVBQUUsU0FBUyxDQUFDLEdBQUcsQ0FBQyxvQkFBa0IsQ0FBQyxDQUFDO1FBQzVGLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO1FBQy9DLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJOztLQUN0QyxDQUFDO0dBQ1csa0JBQWtCLENBZ0w5QjtTQWhMWSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIElucHV0LCBWaWV3Q2hpbGQsIFZpZXdFbmNhcHN1bGF0aW9ufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtDb250cm9sQmFzZX0gZnJvbSAnLi4vY29udHJvbC1iYXNlJztcclxuaW1wb3J0IHtEZWZhdWx0VmFsdWVBY2Nlc3Nvcn0gZnJvbSAnLi4vLi4vaGVscGVyL2RlZmF1bHQtdmFsdWUtYWNjZXNzb3InO1xyXG5pbXBvcnQge1R5cGVBbGlhc30gZnJvbSAnLi4vLi4vaGVscGVyL3R5cGUtYWxpYXMnO1xyXG5pbXBvcnQge09iamVjdEhlbHBlcn0gZnJvbSAnLi4vLi4vaGVscGVyL29iamVjdC1oZWxwZXInO1xyXG5pbXBvcnQge0ZpbGVSZWFkTW9kZVR5cGV9IGZyb20gJy4uLy4uL2hlbHBlci90eXBlcyc7XHJcblxyXG5kZWNsYXJlIHZhciAkOiBhbnk7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEZpbGVFbnRyeSB7XHJcbiAgZmlsZTogRmlsZTtcclxuICBjb250ZW50OiBhbnk7XHJcbn1cclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnbTQtZmlsZS1pbnB1dCcsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL2ZpbGUtaW5wdXQuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL2ZpbGUtaW5wdXQuY29tcG9uZW50Lmxlc3MnXSxcclxuICBwcm92aWRlcnM6IFtEZWZhdWx0VmFsdWVBY2Nlc3Nvci5nZXQoRmlsZUlucHV0Q29tcG9uZW50KSwgVHlwZUFsaWFzLmdldChGaWxlSW5wdXRDb21wb25lbnQpXSxcclxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcclxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGaWxlSW5wdXRDb21wb25lbnQgZXh0ZW5kcyBDb250cm9sQmFzZTxGaWxlIHwgRmlsZVtdIHwgRmlsZUVudHJ5IHwgRmlsZUVudHJ5W10+IHtcclxuXHJcbiAgQElucHV0KCdtdWx0aXBsZScpIG11bHRpcGxlID0gZmFsc2U7XHJcbiAgQElucHV0KCdhY2NlcHQnKSBhY2NlcHQgPSAnJztcclxuICBASW5wdXQoJ3JlYWQnKSByZWFkOiBGaWxlUmVhZE1vZGVUeXBlID0gJyc7XHJcblxyXG4gIEBJbnB1dCgncHJlcGVuZCcpIHByZXBlbmQ6IHN0cmluZztcclxuICBASW5wdXQoJ2J1dHRvbi10aXRsZScpIGJ1dHRvblRpdGxlOiBzdHJpbmc7XHJcbiAgQElucHV0KCdpbmZvLXRleHQnKSBpbmZvVGV4dDogc3RyaW5nO1xyXG4gIEBJbnB1dCgnZHJvcCcpIGRyb3AgPSBmYWxzZTtcclxuXHJcbiAgQElucHV0KCdjbHMtY29tcG9uZW50JykgY2xzQ29tcG9uZW50OiBzdHJpbmc7XHJcbiAgQElucHV0KCdjbHMtY2FwdGlvbicpIGNsc0NhcHRpb246IHN0cmluZztcclxuICBASW5wdXQoJ2Nscy1wcmVwZW5kJykgY2xzUHJlcGVuZDogc3RyaW5nO1xyXG4gIEBJbnB1dCgnY2xzLWJ1dHRvbicpIGNsc0J1dHRvbjogc3RyaW5nO1xyXG5cclxuICBAVmlld0NoaWxkKCdpbnB1dCcsIHtzdGF0aWM6IHRydWV9KSBwcml2YXRlIGlucHV0OiBFbGVtZW50UmVmO1xyXG4gIHByaXZhdGUgZmlsZUlucHV0OiBhbnk7XHJcbiAgcHJpdmF0ZSBjbG9uZWRFbGVtZW50OiBhbnk7XHJcblxyXG4gIGNyZWF0ZUNvbnRyb2woKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKGNvbXBsZXRlKSA9PiB7XHJcbiAgICAgIGNvbnN0IG9yaWdpbmFsRWxlbWVudCA9ICQodGhpcy5pbnB1dC5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgT2JqZWN0SGVscGVyLmhpZGUob3JpZ2luYWxFbGVtZW50KTtcclxuXHJcbiAgICAgIGlmICh0aGlzLmNsb25lZEVsZW1lbnQpIHtcclxuICAgICAgICB0aGlzLmNsb25lZEVsZW1lbnQucGFyZW50KCkucmVtb3ZlKCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuY2xvbmVkRWxlbWVudCA9IG9yaWdpbmFsRWxlbWVudC5jbG9uZSgpO1xyXG4gICAgICBPYmplY3RIZWxwZXIuc2hvdyh0aGlzLmNsb25lZEVsZW1lbnQpO1xyXG4gICAgICBvcmlnaW5hbEVsZW1lbnQucGFyZW50KCkuYXBwZW5kKHRoaXMuY2xvbmVkRWxlbWVudCk7XHJcblxyXG4gICAgICB0aGlzLmZpbGVJbnB1dCA9IHRoaXMuY2xvbmVkRWxlbWVudC5maWxlKCkuZGF0YSgnZmlsZScpO1xyXG5cclxuICAgICAgaWYgKHRoaXMuZHJvcCkge1xyXG4gICAgICAgIGlmICh0aGlzLmJ1dHRvblRpdGxlKSB7XHJcbiAgICAgICAgICBjb25zdCBjYXB0aW9uRWxlbWVudCA9IHRoaXMuY2xvbmVkRWxlbWVudC5jbG9zZXN0KCdsYWJlbC5kcm9wLXpvbmUnKS5maW5kKCdzcGFuLmNhcHRpb24nKTtcclxuICAgICAgICAgIGNhcHRpb25FbGVtZW50Lmh0bWwodGhpcy5idXR0b25UaXRsZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbmZvVGV4dCkge1xyXG4gICAgICAgICAgdGhpcy51cGRhdGVJbmZvVGV4dCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5maWxlSW5wdXQub3B0aW9ucy5vblNlbGVjdCA9IChmaWxlcykgPT4ge1xyXG4gICAgICAgIGlmICh0aGlzLm11bHRpcGxlKSB7XHJcbiAgICAgICAgICBjb25zdCByZXN1bHQ6IEZpbGVbXSA9IFtdO1xyXG5cclxuICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlsZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgcmVzdWx0LnB1c2goZmlsZXNbaV0pO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGlmICh0aGlzLnJlYWQpIHtcclxuICAgICAgICAgICAgdGhpcy5yZWFkRmlsZXMoZmlsZXMpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jaGFuZ2VWYWx1ZShyZXN1bHQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBpZiAodGhpcy5yZWFkKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVhZEZpbGVzKGZpbGVzKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlVmFsdWUoZmlsZXNbMF0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuZHJvcCAmJiB0aGlzLmluZm9UZXh0KSB7XHJcbiAgICAgICAgICB0aGlzLnVwZGF0ZUluZm9UZXh0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG5cclxuICAgICAgdGhpcy5jbG9uZWRFbGVtZW50Lm9uZSgnYmx1cicsICgpID0+IHtcclxuICAgICAgICB0aGlzLnRvdWNoQ2FsbGJhY2soKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb21wbGV0ZSgpO1xyXG4gICAgfSk7XHJcblxyXG4gIH1cclxuXHJcbiAgcmVhZEZpbGVzKGZpbGVzOiBGaWxlW10pIHtcclxuICAgIGNvbnN0IGZpbGVMb2FkUHJvbWlzZXMgPSBbXTtcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IGZpbGUgPSBmaWxlc1tpXTtcclxuXHJcbiAgICAgIGNvbnN0IGxvYWRQcm9taXNlID0gbmV3IFByb21pc2U8RmlsZUVudHJ5PigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcblxyXG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoZSkgPT4ge1xyXG4gICAgICAgICAgcmVzb2x2ZSh7Y29udGVudDogcmVhZGVyLnJlc3VsdCwgZmlsZTogZmlsZX0pO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHN3aXRjaCAodGhpcy5yZWFkKSB7XHJcbiAgICAgICAgICBjYXNlICdhcnJheUJ1ZmZlcic6XHJcbiAgICAgICAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihmaWxlKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICBjYXNlICdiaW5hcnlTdHJpbmcnOlxyXG4gICAgICAgICAgICByZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKGZpbGUpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGNhc2UgJ2RhdGFVcmwnOlxyXG4gICAgICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTChmaWxlKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHJlYWRlci5yZWFkQXNUZXh0KGZpbGUpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgZmlsZUxvYWRQcm9taXNlcy5wdXNoKGxvYWRQcm9taXNlKTtcclxuICAgIH1cclxuXHJcbiAgICBQcm9taXNlLmFsbChmaWxlTG9hZFByb21pc2VzKS50aGVuKChmaWxlRW50cmllczogRmlsZUVudHJ5W10pID0+IHtcclxuICAgICAgaWYgKHRoaXMubXVsdGlwbGUpIHtcclxuICAgICAgICB0aGlzLmNoYW5nZVZhbHVlKGZpbGVFbnRyaWVzKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmNoYW5nZVZhbHVlKGZpbGVFbnRyaWVzWzBdKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBkaXNhYmxlKGRpc2FibGVkOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICBpZiAoZGlzYWJsZWQpIHtcclxuICAgICAgdGhpcy5maWxlSW5wdXQuZGlzYWJsZSgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5maWxlSW5wdXQuZW5hYmxlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZXdWYWx1ZSgpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5maWxlSW5wdXQgfHwgdGhpcy5kcm9wIHx8IHRoaXMucmVhZCB8fCAhdGhpcy5pbm5lclZhbHVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgbmFtZTtcclxuXHJcbiAgICBpZiAodGhpcy5pbm5lclZhbHVlIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgbmFtZSA9ICg8YW55PnRoaXMuaW5uZXJWYWx1ZSkubWFwKCh2OiBGaWxlIHwgRmlsZUVudHJ5KSA9PiB7XHJcbiAgICAgICAgaWYgKHYgaW5zdGFuY2VvZiBGaWxlKSB7XHJcbiAgICAgICAgICByZXR1cm4gdi5uYW1lO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gdi5maWxlLm5hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KS5qb2luKCcsICcpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbmFtZSA9IHRoaXMuaW5uZXJWYWx1ZSBpbnN0YW5jZW9mIEZpbGUgPyB0aGlzLmlubmVyVmFsdWUubmFtZSA6IHRoaXMuaW5uZXJWYWx1ZS5maWxlLm5hbWU7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5jbG9uZWRFbGVtZW50LnBhcmVudCgpLmZpbmQoJ3NwYW4uY2FwdGlvbicpLmh0bWwobmFtZSk7XHJcbiAgfVxyXG5cclxuICBuZXdDbGFzc1ZhbHVlKG5ld0NsYXNzZXM6IHN0cmluZ1tdLCBvbGRDbGFzc2VzOiBzdHJpbmdbXSkge1xyXG4gICAgaWYgKHRoaXMuY2xvbmVkRWxlbWVudCkge1xyXG4gICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmNsb25lZEVsZW1lbnQucGFyZW50KCk7XHJcblxyXG4gICAgICBvbGRDbGFzc2VzLmZvckVhY2goKGNsczogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgdGFyZ2V0LnJlbW92ZUNsYXNzKGNscyk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgbmV3Q2xhc3Nlcy5mb3JFYWNoKChjbHM6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIHRhcmdldC5hZGRDbGFzcyhjbHMpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlSW5mb1RleHQoKSB7XHJcbiAgICBjb25zdCBpbmZvVGV4dENvbnRlbnQgPSB0aGlzLmluZm9UZXh0XHJcbiAgICAgIC5zcGxpdCgnezB9JylcclxuICAgICAgLmpvaW4odGhpcy5pbm5lclZhbHVlIGluc3RhbmNlb2YgQXJyYXkgPyBgJHt0aGlzLmlubmVyVmFsdWUubGVuZ3RofWAgOiB0aGlzLmlubmVyVmFsdWUgPyAnMScgOiAnMCcpO1xyXG5cclxuICAgIGNvbnN0IGluZm9UZXh0RWxlbWVudCA9IHRoaXMuY2xvbmVkRWxlbWVudC5jbG9zZXN0KCdsYWJlbC5kcm9wLXpvbmUnKS5maW5kKCdzcGFuLmZpbGVzJyk7XHJcbiAgICBpbmZvVGV4dEVsZW1lbnQuaHRtbChpbmZvVGV4dENvbnRlbnQpO1xyXG4gIH1cclxuXHJcbn1cclxuIl19