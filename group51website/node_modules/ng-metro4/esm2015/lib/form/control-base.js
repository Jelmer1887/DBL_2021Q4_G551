import { __decorate, __metadata, __param } from "tslib";
import { AfterViewInit, ChangeDetectorRef, ElementRef, OnChanges, OnDestroy, Optional, SimpleChange, SimpleChanges, Directive } from '@angular/core';
import { ObjectHelper } from '../helper/object-helper';
import { asapScheduler } from 'rxjs';
import { AttributeHelper } from '../helper/attribute-helper';
let ControlBase = class ControlBase {
    constructor(mainElement, cdRef) {
        this.mainElement = mainElement;
        this.cdRef = cdRef;
        this.disableUpdate = false;
        this.touchCallback = () => { };
        this.changeCallback = (_) => { };
    }
    observeClassValue() {
        this.classObserver = AttributeHelper.createObserver(this.mainElement, (newClasses, oldClasses) => {
            this.currentClasses = newClasses;
            this.newClassValue(newClasses, oldClasses);
        });
    }
    changeValue(newValue, callback = true) {
        if (this.disableUpdate) {
            return;
        }
        if (ObjectHelper.compare(newValue, this.innerValue)) {
            return;
        }
        this.innerValue = newValue;
        if (callback) {
            this.changeCallback(this.innerValue);
        }
    }
    registerOnChange(fn) {
        this.changeCallback = fn;
    }
    registerOnTouched(fn) {
        this.touchCallback = fn;
    }
    setDisabledState(isDisabled) {
        this.disabled = isDisabled;
        this.disable(isDisabled);
    }
    callNewValue() {
        this.disableUpdate = true;
        this.newValue();
        this.disableUpdate = false;
    }
    writeValue(newValue) {
        this.innerValue = newValue;
        this.callNewValue();
    }
    ngAfterViewInit() {
        this.createControl().then(() => {
            this.callNewValue();
            this.observeClassValue();
        });
    }
    ngOnChanges(changes) {
        asapScheduler.schedule(() => {
            this.createControl().then(() => {
                this.setDisabledState(this.disabled);
                this.callNewValue();
                if (this.currentClasses) {
                    this.newClassValue(this.currentClasses, []);
                }
            });
        });
    }
    ngOnDestroy() {
        if (this.classObserver) {
            this.classObserver.disconnect();
        }
    }
    updateProperty(key, newValue) {
        const oldValue = this[key];
        if (oldValue !== newValue) {
            this[key] = newValue;
            if (this.cdRef) {
                this.cdRef.detectChanges();
            }
            const changes = {};
            changes[key] = { previousValue: oldValue, currentValue: newValue, firstChange: false };
            this.ngOnChanges(changes);
        }
    }
};
ControlBase.ctorParameters = () => [
    { type: ElementRef, decorators: [{ type: Optional }] },
    { type: ChangeDetectorRef }
];
ControlBase = __decorate([
    Directive(),
    __param(0, Optional()),
    __metadata("design:paramtypes", [ElementRef, ChangeDetectorRef])
], ControlBase);
export { ControlBase };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbC1iYXNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctbWV0cm80LyIsInNvdXJjZXMiOlsibGliL2Zvcm0vY29udHJvbC1iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsYUFBYSxFQUFFLGlCQUFpQixFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNySixPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDckQsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNuQyxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFHM0QsSUFBc0IsV0FBVyxHQUFqQyxNQUFzQixXQUFXO0lBVy9CLFlBQStCLFdBQXVCLEVBQVUsS0FBd0I7UUFBekQsZ0JBQVcsR0FBWCxXQUFXLENBQVk7UUFBVSxVQUFLLEdBQUwsS0FBSyxDQUFtQjtRQUxqRixrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUV0QixrQkFBYSxHQUFlLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQztRQUNyQyxtQkFBYyxHQUE4QixDQUFDLENBQUMsRUFBRSxFQUFFLEdBQUUsQ0FBQyxDQUFDO0lBRThCLENBQUM7SUFFcEYsaUJBQWlCO1FBQ3ZCLElBQUksQ0FBQyxhQUFhLEdBQUcsZUFBZSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsVUFBVSxFQUFFLFVBQVUsRUFBRSxFQUFFO1lBQy9GLElBQUksQ0FBQyxjQUFjLEdBQUcsVUFBVSxDQUFDO1lBQ2pDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQzdDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUlNLFdBQVcsQ0FBQyxRQUFXLEVBQUUsV0FBb0IsSUFBSTtRQUN0RCxJ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QUU7SUFZRyxXQUFBLFFBQVEsRUFBRSxDQUFBO3FDQUFxQixVQUFVLEVBQWlCLGlCQUFpQjtHQVhwRSxXQUFXLENBNEdoQztTQTVHcUIsV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29udHJvbFZhbHVlQWNjZXNzb3J9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgQ2hhbmdlRGV0ZWN0b3JSZWYsIEVsZW1lbnRSZWYsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBPcHRpb25hbCwgU2ltcGxlQ2hhbmdlLCBTaW1wbGVDaGFuZ2VzLCBEaXJlY3RpdmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtPYmplY3RIZWxwZXJ9IGZyb20gJy4uL2hlbHBlci9vYmplY3QtaGVscGVyJztcclxuaW1wb3J0IHthc2FwU2NoZWR1bGVyfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtBdHRyaWJ1dGVIZWxwZXJ9IGZyb20gJy4uL2hlbHBlci9hdHRyaWJ1dGUtaGVscGVyJztcclxuXHJcbkBEaXJlY3RpdmUoKVxyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQ29udHJvbEJhc2U8VD4gaW1wbGVtZW50cyBDb250cm9sVmFsdWVBY2Nlc3NvciwgQWZ0ZXJWaWV3SW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG4gIHByaXZhdGUgY2xhc3NPYnNlcnZlcjogTXV0YXRpb25PYnNlcnZlcjtcclxuICBwcml2YXRlIGRpc2FibGVkOiBib29sZWFuO1xyXG4gIHByaXZhdGUgY3VycmVudENsYXNzZXM6IHN0cmluZ1tdO1xyXG5cclxuICBwdWJsaWMgaW5uZXJWYWx1ZTogVDtcclxuICBwdWJsaWMgZGlzYWJsZVVwZGF0ZSA9IGZhbHNlO1xyXG5cclxuICBwdWJsaWMgdG91Y2hDYWxsYmFjazogKCkgPT4gdm9pZCA9ICgpID0+IHt9O1xyXG4gIHB1YmxpYyBjaGFuZ2VDYWxsYmFjazogKGN1cnJlbnRWYWx1ZTogVCkgPT4gdm9pZCA9IChfKSA9PiB7fTtcclxuXHJcbiAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgcHVibGljIG1haW5FbGVtZW50OiBFbGVtZW50UmVmLCBwcml2YXRlIGNkUmVmOiBDaGFuZ2VEZXRlY3RvclJlZikge31cclxuXHJcbiAgcHJpdmF0ZSBvYnNlcnZlQ2xhc3NWYWx1ZSgpIHtcclxuICAgIHRoaXMuY2xhc3NPYnNlcnZlciA9IEF0dHJpYnV0ZUhlbHBlci5jcmVhdGVPYnNlcnZlcih0aGlzLm1haW5FbGVtZW50LCAobmV3Q2xhc3Nlcywgb2xkQ2xhc3NlcykgPT4ge1xyXG4gICAgICB0aGlzLmN1cnJlbnRDbGFzc2VzID0gbmV3Q2xhc3NlcztcclxuICAgICAgdGhpcy5uZXdDbGFzc1ZhbHVlKG5ld0NsYXNzZXMsIG9sZENsYXNzZXMpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYWJzdHJhY3QgbmV3Q2xhc3NWYWx1ZShuZXdDbGFzc2VzOiBzdHJpbmdbXSwgb2xkQ2xhc3Nlczogc3RyaW5nW10pO1xyXG5cclxuICBwdWJsaWMgY2hhbmdlVmFsdWUobmV3VmFsdWU6IFQsIGNhbGxiYWNrOiBib29sZWFuID0gdHJ1ZSkge1xyXG4gICAgaWYgKHRoaXMuZGlzYWJsZVVwZGF0ZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKE9iamVjdEhlbHBlci5jb21wYXJlKG5ld1ZhbHVlLCB0aGlzLmlubmVyVmFsdWUpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmlubmVyVmFsdWUgPSBuZXdWYWx1ZTtcclxuXHJcbiAgICBpZiAoY2FsbGJhY2spIHtcclxuICAgICAgdGhpcy5jaGFuZ2VDYWxsYmFjayh0aGlzLmlubmVyVmFsdWUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVnaXN0ZXJPbkNoYW5nZShmbjogKHY6IFQpID0+IHZvaWQpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hhbmdlQ2FsbGJhY2sgPSBmbjtcclxuICB9XHJcblxyXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiAoKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICB0aGlzLnRvdWNoQ2FsbGJhY2sgPSBmbjtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhYnN0cmFjdCBkaXNhYmxlKGRpc2FibGVkOiBib29sZWFuKTtcclxuXHJcbiAgc2V0RGlzYWJsZWRTdGF0ZShpc0Rpc2FibGVkOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc2FibGVkID0gaXNEaXNhYmxlZDtcclxuICAgIHRoaXMuZGlzYWJsZShpc0Rpc2FibGVkKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhYnN0cmFjdCBuZXdWYWx1ZSgpO1xyXG5cclxuICBjYWxsTmV3VmFsdWUoKSB7XHJcbiAgICB0aGlzLmRpc2FibGVVcGRhdGUgPSB0cnVlO1xyXG4gICAgdGhpcy5uZXdWYWx1ZSgpO1xyXG4gICAgdGhpcy5kaXNhYmxlVXBkYXRlID0gZmFsc2U7XHJcbiAgfVxyXG5cclxuICB3cml0ZVZhbHVlKG5ld1ZhbHVlOiBUKTogdm9pZCB7XHJcbiAgICB0aGlzLmlubmVyVmFsdWUgPSBuZXdWYWx1ZTtcclxuICAgIHRoaXMuY2FsbE5ld1ZhbHVlKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYWJzdHJhY3QgY3JlYXRlQ29udHJvbCgpOiBQcm9taXNlPHZvaWQ+O1xyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICB0aGlzLmNyZWF0ZUNvbnRyb2woKS50aGVuKCgpID0+IHtcclxuICAgICAgdGhpcy5jYWxsTmV3VmFsdWUoKTtcclxuICAgICAgdGhpcy5vYnNlcnZlQ2xhc3NWYWx1ZSgpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XHJcbiAgICBhc2FwU2NoZWR1bGVyLnNjaGVkdWxlKCgpID0+IHtcclxuICAgICAgdGhpcy5jcmVhdGVDb250cm9sKCkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXREaXNhYmxlZFN0YXRlKHRoaXMuZGlzYWJsZWQpO1xyXG4gICAgICAgIHRoaXMuY2FsbE5ld1ZhbHVlKCk7XHJcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudENsYXNzZXMpIHtcclxuICAgICAgICAgIHRoaXMubmV3Q2xhc3NWYWx1ZSh0aGlzLmN1cnJlbnRDbGFzc2VzLCBbXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5jbGFzc09ic2VydmVyKSB7XHJcbiAgICAgIHRoaXMuY2xhc3NPYnNlcnZlci5kaXNjb25uZWN0KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICB1cGRhdGVQcm9wZXJ0eShrZXk6IGtleW9mIHRoaXMsIG5ld1ZhbHVlOiBhbnkpIHtcclxuICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpc1trZXldO1xyXG5cclxuICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHtcclxuICAgICAgdGhpc1trZXldID0gbmV3VmFsdWU7XHJcblxyXG4gICAgICBpZiAodGhpcy5jZFJlZikge1xyXG4gICAgICAgIHRoaXMuY2RSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzID0ge307XHJcbiAgICAgIGNoYW5nZXNba2V5IGFzIHN0cmluZ10gPSB7IHByZXZpb3VzVmFsdWU6IG9sZFZhbHVlLCBjdXJyZW50VmFsdWU6IG5ld1ZhbHVlLCBmaXJzdENoYW5nZTogZmFsc2UgfSBhcyBTaW1wbGVDaGFuZ2U7XHJcbiAgICAgIHRoaXMubmdPbkNoYW5nZXMoY2hhbmdlcyk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==