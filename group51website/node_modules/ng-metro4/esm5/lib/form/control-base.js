import { __decorate, __metadata, __param } from "tslib";
import { AfterViewInit, ChangeDetectorRef, ElementRef, OnChanges, OnDestroy, Optional, SimpleChange, SimpleChanges, Directive } from '@angular/core';
import { ObjectHelper } from '../helper/object-helper';
import { asapScheduler } from 'rxjs';
import { AttributeHelper } from '../helper/attribute-helper';
var ControlBase = /** @class */ (function () {
    function ControlBase(mainElement, cdRef) {
        this.mainElement = mainElement;
        this.cdRef = cdRef;
        this.disableUpdate = false;
        this.touchCallback = function () { };
        this.changeCallback = function (_) { };
    }
    ControlBase.prototype.observeClassValue = function () {
        var _this = this;
        this.classObserver = AttributeHelper.createObserver(this.mainElement, function (newClasses, oldClasses) {
            _this.currentClasses = newClasses;
            _this.newClassValue(newClasses, oldClasses);
        });
    };
    ControlBase.prototype.changeValue = function (newValue, callback) {
        if (callback === void 0) { callback = true; }
        if (this.disableUpdate) {
            return;
        }
        if (ObjectHelper.compare(newValue, this.innerValue)) {
            return;
        }
        this.innerValue = newValue;
        if (callback) {
            this.changeCallback(this.innerValue);
        }
    };
    ControlBase.prototype.registerOnChange = function (fn) {
        this.changeCallback = fn;
    };
    ControlBase.prototype.registerOnTouched = function (fn) {
        this.touchCallback = fn;
    };
    ControlBase.prototype.setDisabledState = function (isDisabled) {
        this.disabled = isDisabled;
        this.disable(isDisabled);
    };
    ControlBase.prototype.callNewValue = function () {
        this.disableUpdate = true;
        this.newValue();
        this.disableUpdate = false;
    };
    ControlBase.prototype.writeValue = function (newValue) {
        this.innerValue = newValue;
        this.callNewValue();
    };
    ControlBase.prototype.ngAfterViewInit = function () {
        var _this = this;
        this.createControl().then(function () {
            _this.callNewValue();
            _this.observeClassValue();
        });
    };
    ControlBase.prototype.ngOnChanges = function (changes) {
        var _this = this;
        asapScheduler.schedule(function () {
            _this.createControl().then(function () {
                _this.setDisabledState(_this.disabled);
                _this.callNewValue();
                if (_this.currentClasses) {
                    _this.newClassValue(_this.currentClasses, []);
                }
            });
        });
    };
    ControlBase.prototype.ngOnDestroy = function () {
        if (this.classObserver) {
            this.classObserver.disconnect();
        }
    };
    ControlBase.prototype.updateProperty = function (key, newValue) {
        var oldValue = this[key];
        if (oldValue !== newValue) {
            this[key] = newValue;
            if (this.cdRef) {
                this.cdRef.detectChanges();
            }
            var changes = {};
            changes[key] = { previousValue: oldValue, currentValue: newValue, firstChange: false };
            this.ngOnChanges(changes);
        }
    };
    ControlBase.ctorParameters = function () { return [
        { type: ElementRef, decorators: [{ type: Optional }] },
        { type: ChangeDetectorRef }
    ]; };
    ControlBase = __decorate([
        Directive(),
        __param(0, Optional()),
        __metadata("design:paramtypes", [ElementRef, ChangeDetectorRef])
    ], ControlBase);
    return ControlBase;
}());
export { ControlBase };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbC1iYXNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctbWV0cm80LyIsInNvdXJjZXMiOlsibGliL2Zvcm0vY29udHJvbC1iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsYUFBYSxFQUFFLGlCQUFpQixFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNySixPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDckQsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNuQyxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFHM0Q7SUFXRSxxQkFBK0IsV0FBdUIsRUFBVSxLQUF3QjtRQUF6RCxnQkFBVyxHQUFYLFdBQVcsQ0FBWTtRQUFVLFVBQUssR0FBTCxLQUFLLENBQW1CO1FBTGpGLGtCQUFhLEdBQUcsS0FBSyxDQUFDO1FBRXRCLGtCQUFhLEdBQWUsY0FBTyxDQUFDLENBQUM7UUFDckMsbUJBQWMsR0FBOEIsVUFBQyxDQUFDLElBQU0sQ0FBQyxDQUFDO0lBRThCLENBQUM7SUFFcEYsdUNBQWlCLEdBQXpCO1FBQUEsaUJBS0M7UUFKQyxJQUFJLENBQUMsYUFBYSxHQUFHLGVBQWUsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxVQUFDLFVBQVUsRUFBRSxVQUFVO1lBQzNGLEtBQUksQ0FBQyxjQUFjLEdBQUcsVUFBVSxDQUFDO1lBQ2pDLEtBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQzdDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUlNLGlDQUFXLEdBQWxCLFVBQW1CLFFBQVcsRUFBRSxRQUF3QjtRQUF4Qix5QkFBQSxFQUFBLGVBQXdCO1FBQ3RELElBQUksSUFBSSxDQUFDLGFB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O0lBWHBFLFdBQVc7UUFEaEMsU0FBUyxFQUFFO1FBWUcsV0FBQSxRQUFRLEVBQUUsQ0FBQTt5Q0FBcUIsVUFBVSxFQUFpQixpQkFBaUI7T0FYcEUsV0FBVyxDQTRHaEM7SUFBRCxrQkFBQztDQUFBLEFBNUdELElBNEdDO1NBNUdxQixXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb250cm9sVmFsdWVBY2Nlc3Nvcn0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDaGFuZ2VEZXRlY3RvclJlZiwgRWxlbWVudFJlZiwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIE9wdGlvbmFsLCBTaW1wbGVDaGFuZ2UsIFNpbXBsZUNoYW5nZXMsIERpcmVjdGl2ZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge09iamVjdEhlbHBlcn0gZnJvbSAnLi4vaGVscGVyL29iamVjdC1oZWxwZXInO1xyXG5pbXBvcnQge2FzYXBTY2hlZHVsZXJ9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge0F0dHJpYnV0ZUhlbHBlcn0gZnJvbSAnLi4vaGVscGVyL2F0dHJpYnV0ZS1oZWxwZXInO1xyXG5cclxuQERpcmVjdGl2ZSgpXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBDb250cm9sQmFzZTxUPiBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XHJcbiAgcHJpdmF0ZSBjbGFzc09ic2VydmVyOiBNdXRhdGlvbk9ic2VydmVyO1xyXG4gIHByaXZhdGUgZGlzYWJsZWQ6IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSBjdXJyZW50Q2xhc3Nlczogc3RyaW5nW107XHJcblxyXG4gIHB1YmxpYyBpbm5lclZhbHVlOiBUO1xyXG4gIHB1YmxpYyBkaXNhYmxlVXBkYXRlID0gZmFsc2U7XHJcblxyXG4gIHB1YmxpYyB0b3VjaENhbGxiYWNrOiAoKSA9PiB2b2lkID0gKCkgPT4ge307XHJcbiAgcHVibGljIGNoYW5nZUNhbGxiYWNrOiAoY3VycmVudFZhbHVlOiBUKSA9PiB2b2lkID0gKF8pID0+IHt9O1xyXG5cclxuICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBwdWJsaWMgbWFpbkVsZW1lbnQ6IEVsZW1lbnRSZWYsIHByaXZhdGUgY2RSZWY6IENoYW5nZURldGVjdG9yUmVmKSB7fVxyXG5cclxuICBwcml2YXRlIG9ic2VydmVDbGFzc1ZhbHVlKCkge1xyXG4gICAgdGhpcy5jbGFzc09ic2VydmVyID0gQXR0cmlidXRlSGVscGVyLmNyZWF0ZU9ic2VydmVyKHRoaXMubWFpbkVsZW1lbnQsIChuZXdDbGFzc2VzLCBvbGRDbGFzc2VzKSA9PiB7XHJcbiAgICAgIHRoaXMuY3VycmVudENsYXNzZXMgPSBuZXdDbGFzc2VzO1xyXG4gICAgICB0aGlzLm5ld0NsYXNzVmFsdWUobmV3Q2xhc3Nlcywgb2xkQ2xhc3Nlcyk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhYnN0cmFjdCBuZXdDbGFzc1ZhbHVlKG5ld0NsYXNzZXM6IHN0cmluZ1tdLCBvbGRDbGFzc2VzOiBzdHJpbmdbXSk7XHJcblxyXG4gIHB1YmxpYyBjaGFuZ2VWYWx1ZShuZXdWYWx1ZTogVCwgY2FsbGJhY2s6IGJvb2xlYW4gPSB0cnVlKSB7XHJcbiAgICBpZiAodGhpcy5kaXNhYmxlVXBkYXRlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoT2JqZWN0SGVscGVyLmNvbXBhcmUobmV3VmFsdWUsIHRoaXMuaW5uZXJWYWx1ZSkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuaW5uZXJWYWx1ZSA9IG5ld1ZhbHVlO1xyXG5cclxuICAgIGlmIChjYWxsYmFjaykge1xyXG4gICAgICB0aGlzLmNoYW5nZUNhbGxiYWNrKHRoaXMuaW5uZXJWYWx1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWdpc3Rlck9uQ2hhbmdlKGZuOiAodjogVCkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgdGhpcy5jaGFuZ2VDYWxsYmFjayA9IGZuO1xyXG4gIH1cclxuXHJcbiAgcmVnaXN0ZXJPblRvdWNoZWQoZm46ICgpID0+IHZvaWQpOiB2b2lkIHtcclxuICAgIHRoaXMudG91Y2hDYWxsYmFjayA9IGZuO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFic3RyYWN0IGRpc2FibGUoZGlzYWJsZWQ6IGJvb2xlYW4pO1xyXG5cclxuICBzZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQ6IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzYWJsZWQgPSBpc0Rpc2FibGVkO1xyXG4gICAgdGhpcy5kaXNhYmxlKGlzRGlzYWJsZWQpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFic3RyYWN0IG5ld1ZhbHVlKCk7XHJcblxyXG4gIGNhbGxOZXdWYWx1ZSgpIHtcclxuICAgIHRoaXMuZGlzYWJsZVVwZGF0ZSA9IHRydWU7XHJcbiAgICB0aGlzLm5ld1ZhbHVlKCk7XHJcbiAgICB0aGlzLmRpc2FibGVVcGRhdGUgPSBmYWxzZTtcclxuICB9XHJcblxyXG4gIHdyaXRlVmFsdWUobmV3VmFsdWU6IFQpOiB2b2lkIHtcclxuICAgIHRoaXMuaW5uZXJWYWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgdGhpcy5jYWxsTmV3VmFsdWUoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhYnN0cmFjdCBjcmVhdGVDb250cm9sKCk6IFByb21pc2U8dm9pZD47XHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgIHRoaXMuY3JlYXRlQ29udHJvbCgpLnRoZW4oKCkgPT4ge1xyXG4gICAgICB0aGlzLmNhbGxOZXdWYWx1ZSgpO1xyXG4gICAgICB0aGlzLm9ic2VydmVDbGFzc1ZhbHVlKCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgIGFzYXBTY2hlZHVsZXIuc2NoZWR1bGUoKCkgPT4ge1xyXG4gICAgICB0aGlzLmNyZWF0ZUNvbnRyb2woKS50aGVuKCgpID0+IHtcclxuICAgICAgICB0aGlzLnNldERpc2FibGVkU3RhdGUodGhpcy5kaXNhYmxlZCk7XHJcbiAgICAgICAgdGhpcy5jYWxsTmV3VmFsdWUoKTtcclxuICAgICAgICBpZiAodGhpcy5jdXJyZW50Q2xhc3Nlcykge1xyXG4gICAgICAgICAgdGhpcy5uZXdDbGFzc1ZhbHVlKHRoaXMuY3VycmVudENsYXNzZXMsIFtdKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmNsYXNzT2JzZXJ2ZXIpIHtcclxuICAgICAgdGhpcy5jbGFzc09ic2VydmVyLmRpc2Nvbm5lY3QoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHVwZGF0ZVByb3BlcnR5KGtleToga2V5b2YgdGhpcywgbmV3VmFsdWU6IGFueSkge1xyXG4gICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzW2tleV07XHJcblxyXG4gICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkge1xyXG4gICAgICB0aGlzW2tleV0gPSBuZXdWYWx1ZTtcclxuXHJcbiAgICAgIGlmICh0aGlzLmNkUmVmKSB7XHJcbiAgICAgICAgdGhpcy5jZFJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMgPSB7fTtcclxuICAgICAgY2hhbmdlc1trZXkgYXMgc3RyaW5nXSA9IHsgcHJldmlvdXNWYWx1ZTogb2xkVmFsdWUsIGN1cnJlbnRWYWx1ZTogbmV3VmFsdWUsIGZpcnN0Q2hhbmdlOiBmYWxzZSB9IGFzIFNpbXBsZUNoYW5nZTtcclxuICAgICAgdGhpcy5uZ09uQ2hhbmdlcyhjaGFuZ2VzKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19