import { __decorate, __extends, __metadata } from "tslib";
import { ChangeDetectionStrategy, Component, ElementRef, Input, ViewChild } from '@angular/core';
import { ControlBase } from '../control-base';
import { DefaultValueAccessor } from '../../helper/default-value-accessor';
import { TypeAlias } from '../../helper/type-alias';
import { asapScheduler } from 'rxjs';
import { ObjectHelper } from '../../helper/object-helper';
import { StringHelper } from '../../helper/string-helper';
var SelectComponent = /** @class */ (function (_super) {
    __extends(SelectComponent, _super);
    function SelectComponent() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.multiple = false;
        _this.duration = 0;
        return _this;
    }
    SelectComponent_1 = SelectComponent;
    SelectComponent.prototype.createControl = function () {
        var _this = this;
        return new Promise(function (complete) {
            var originalElement = $(_this.input.nativeElement);
            ObjectHelper.hide(originalElement);
            if (_this.clonedElement) {
                _this.clonedElement.children().appendTo(originalElement);
                _this.clonedElement.parent().remove();
            }
            _this.clonedElement = originalElement.clone();
            ObjectHelper.show(_this.clonedElement);
            originalElement.parent().append(_this.clonedElement);
            originalElement.children().appendTo(_this.clonedElement);
            _this.select = _this.clonedElement.select().data('select');
            _this.clonedElement.parent().on('mousedown', function (ev) {
                if (ev.button === 0) {
                    _this.touchCallback();
                    _this.clonedElement.parent().off('mousedown');
                }
            });
            _this.select.options.onChange = function (val) {
                if (_this.options instanceof Array) {
                    var allOptions_1 = [];
                    _this.options.forEach(function (option) {
                        if (!!option.options) {
                            option.options.forEach(function (subOption) {
                                allOptions_1.push(subOption);
                            });
                        }
                        else {
                            allOptions_1.push(option);
                        }
                    });
                    val = val.map(function (key) { return allOptions_1.find(function (option) { return StringHelper.createHash(option.value) === key; }); }).filter(function (v) { return !!v; }).map(function (v) { return v.value; });
                }
                if (_this.multiple) {
                    _this.changeValue(val.slice(0));
                }
                else {
                    _this.changeValue(val[0]);
                }
            };
            if (_this.options && !(_this.options instanceof Array)) {
                _this.select.data(_this.options);
            }
            complete();
        });
    };
    SelectComponent.prototype.disable = function (disabled) {
        if (disabled) {
            this.select.disable();
        }
        else {
            this.select.enable();
        }
    };
    SelectComponent.prototype.newValue = function () {
        if (!this.select) {
            return;
        }
        var selectValue = this.multiple ? this.innerValue : [this.innerValue];
        if (this.options instanceof Array) {
            selectValue = selectValue.map(function (v) { return StringHelper.createHash(v); });
        }
        if (this.multiple) {
            this.select.reset();
        }
        this.select.val(selectValue);
    };
    SelectComponent.prototype.newClassValue = function (newClasses, oldClasses) {
        var _this = this;
        asapScheduler.schedule(function () {
            if (_this.clonedElement) {
                var target_1 = _this.clonedElement.parent();
                oldClasses.forEach(function (cls) {
                    target_1.removeClass(cls);
                });
                newClasses.forEach(function (cls) {
                    target_1.addClass(cls);
                });
            }
        }, 1);
    };
    var SelectComponent_1;
    __decorate([
        Input('options'),
        __metadata("design:type", Object)
    ], SelectComponent.prototype, "options", void 0);
    __decorate([
        Input('multiple'),
        __metadata("design:type", Object)
    ], SelectComponent.prototype, "multiple", void 0);
    __decorate([
        Input('duration'),
        __metadata("design:type", Object)
    ], SelectComponent.prototype, "duration", void 0);
    __decorate([
        Input('prepend'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "prepend", void 0);
    __decorate([
        Input('append'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "append", void 0);
    __decorate([
        Input('drop-height'),
        __metadata("design:type", Number)
    ], SelectComponent.prototype, "dropHeight", void 0);
    __decorate([
        Input('filter'),
        __metadata("design:type", Boolean)
    ], SelectComponent.prototype, "filter", void 0);
    __decorate([
        Input('filter-placeholder'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "filterPlaceholder", void 0);
    __decorate([
        Input('cls-select'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "clsSelect", void 0);
    __decorate([
        Input('cls-prepend'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "clsPrepend", void 0);
    __decorate([
        Input('cls-append'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "clsAppend", void 0);
    __decorate([
        Input('cls-option'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "clsOption", void 0);
    __decorate([
        Input('cls-option-group'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "clsOptionGroup", void 0);
    __decorate([
        Input('cls-drop-list'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "clsDropList", void 0);
    __decorate([
        Input('cls-selected-item'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "clsSelectedItem", void 0);
    __decorate([
        Input('cls-selected-item-remover'),
        __metadata("design:type", String)
    ], SelectComponent.prototype, "clsSelectedItemRemover", void 0);
    __decorate([
        ViewChild('input', { static: true }),
        __metadata("design:type", ElementRef)
    ], SelectComponent.prototype, "input", void 0);
    SelectComponent = SelectComponent_1 = __decorate([
        Component({
            selector: 'm4-select',
            template: "<select #input [multiple]=\"multiple\"\r\n\r\n\r\n        [attr.data-prepend]=\"prepend\"\r\n        [attr.data-duration]=\"duration\"\r\n        [attr.data-append]=\"append\"\r\n        [attr.data-drop-height]=\"dropHeight\"\r\n        [attr.data-filter]=\"filter\"\r\n        [attr.data-filter-placeholder]=\"filterPlaceholder\"\r\n\r\n        [attr.data-cls-select]=\"clsSelect\"\r\n        [attr.data-cls-prepend]=\"clsPrepend\"\r\n        [attr.data-cls-append]=\"clsAppend\"\r\n        [attr.data-cls-option]=\"clsOption\"\r\n        [attr.data-cls-option-group]=\"clsOptionGroup\"\r\n        [attr.data-cls-drop-list]=\"clsDropList\"\r\n        [attr.data-cls-selected-item]=\"clsSelectedItem\"\r\n        [attr.data-cls-selected-item-remover]=\"clsSelectedItemRemover\">\r\n\r\n  <ng-content *ngIf=\"!options\"></ng-content>\r\n\r\n  <ng-container *ngIf=\"options | isArray\">\r\n    <ng-container *ngFor=\"let option of options\">\r\n      <option *ngIf=\"!option.options\" [value]=\"option.value | createHash\" [attr.data-template]=\"option.dataTemplate\">\r\n        {{option.title}}\r\n      </option>\r\n\r\n      <optgroup *ngIf=\"option.options\" [label]=\"option.groupName\">\r\n        <option *ngFor=\"let childOption of option.options\" [value]=\"childOption.value | createHash\" [attr.data-template]=\"childOption.dataTemplate\">\r\n          {{childOption.title}}\r\n        </option>\r\n      </optgroup>\r\n    </ng-container>\r\n  </ng-container>\r\n</select>\r\n",
            providers: [DefaultValueAccessor.get(SelectComponent_1), TypeAlias.get(SelectComponent_1)],
            changeDetection: ChangeDetectionStrategy.OnPush,
            styles: [""]
        })
    ], SelectComponent);
    return SelectComponent;
}(ControlBase));
export { SelectComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLW1ldHJvNC8iLCJzb3VyY2VzIjpbImxpYi9mb3JtL3NlbGVjdC9zZWxlY3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQWEsU0FBUyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQzFHLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUN6RSxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDbEQsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNuQyxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFDeEQsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLDRCQUE0QixDQUFDO0FBaUJ4RDtJQUFxQyxtQ0FBNEI7SUFBakU7UUFBQSxxRUEySEM7UUF2SG9CLGNBQVEsR0FBRyxLQUFLLENBQUM7UUFDakIsY0FBUSxHQUFHLENBQUMsQ0FBQzs7SUFzSGxDLENBQUM7d0JBM0hZLGVBQWU7SUF5QjFCLHVDQUFhLEdBQWI7UUFBQSxpQkF1REM7UUF0REMsT0FBTyxJQUFJLE9BQU8sQ0FBTyxVQUFDLFFBQVE7WUFDaEMsSUFBTSxlQUFlLEdBQUcsQ0FBQyxDQUFDLEtBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDcEQsWUFBWSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUVuQyxJQUFJLEtBQUksQ0FBQyxhQUFhLEVBQUU7Z0JBQ3RCLEtBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dCQUN4RCxLQUFJLENBQUMsYUFBYSxDQUFD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LEdBQUcsQ0FBQyxpQkFBZSxDQUFDLENBQUM7WUFDdEYsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07O1NBQ2hELENBQUM7T0FDVyxlQUFlLENBMkgzQjtJQUFELHNCQUFDO0NBQUEsQUEzSEQsQ0FBcUMsV0FBVyxHQTJIL0M7U0EzSFksZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5wdXQsIE9uQ2hhbmdlcywgVmlld0NoaWxkfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtDb250cm9sQmFzZX0gZnJvbSAnLi4vY29udHJvbC1iYXNlJztcclxuaW1wb3J0IHtEZWZhdWx0VmFsdWVBY2Nlc3Nvcn0gZnJvbSAnLi4vLi4vaGVscGVyL2RlZmF1bHQtdmFsdWUtYWNjZXNzb3InO1xyXG5pbXBvcnQge1R5cGVBbGlhc30gZnJvbSAnLi4vLi4vaGVscGVyL3R5cGUtYWxpYXMnO1xyXG5pbXBvcnQge2FzYXBTY2hlZHVsZXJ9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQge09iamVjdEhlbHBlcn0gZnJvbSAnLi4vLi4vaGVscGVyL29iamVjdC1oZWxwZXInO1xyXG5pbXBvcnQge1N0cmluZ0hlbHBlcn0gZnJvbSAnLi4vLi4vaGVscGVyL3N0cmluZy1oZWxwZXInO1xyXG5cclxuZGVjbGFyZSB2YXIgJDogYW55O1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBPcHRpb24ge1xyXG4gIHRpdGxlOiBzdHJpbmc7XHJcbiAgZGF0YVRlbXBsYXRlOiBzdHJpbmc7XHJcbiAgdmFsdWU6IGFueTtcclxufVxyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdtNC1zZWxlY3QnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9zZWxlY3QuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsczogWycuL3NlbGVjdC5jb21wb25lbnQuY3NzJ10sXHJcbiAgcHJvdmlkZXJzOiBbRGVmYXVsdFZhbHVlQWNjZXNzb3IuZ2V0KFNlbGVjdENvbXBvbmVudCksIFR5cGVBbGlhcy5nZXQoU2VsZWN0Q29tcG9uZW50KV0sXHJcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2hcclxufSlcclxuZXhwb3J0IGNsYXNzIFNlbGVjdENvbXBvbmVudCBleHRlbmRzIENvbnRyb2xCYXNlPG9iamVjdHxvYmplY3RbXT4gaW1wbGVtZW50cyBPbkNoYW5nZXMge1xyXG5cclxuICBASW5wdXQoJ29wdGlvbnMnKSBvcHRpb25zOiB7IFtrZXk6IHN0cmluZ106IChzdHJpbmcgfCB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9KSB9IHxcclxuICAgIChPcHRpb24gfCB7IGdyb3VwTmFtZTogc3RyaW5nLCBvcHRpb25zOiBPcHRpb25bXSB9KVtdO1xyXG4gIEBJbnB1dCgnbXVsdGlwbGUnKSBtdWx0aXBsZSA9IGZhbHNlO1xyXG4gIEBJbnB1dCgnZHVyYXRpb24nKSBkdXJhdGlvbiA9IDA7XHJcbiAgQElucHV0KCdwcmVwZW5kJykgcHJlcGVuZDogc3RyaW5nO1xyXG4gIEBJbnB1dCgnYXBwZW5kJykgYXBwZW5kOiBzdHJpbmc7XHJcbiAgQElucHV0KCdkcm9wLWhlaWdodCcpIGRyb3BIZWlnaHQ6IG51bWJlcjtcclxuICBASW5wdXQoJ2ZpbHRlcicpIGZpbHRlcjogYm9vbGVhbjtcclxuICBASW5wdXQoJ2ZpbHRlci1wbGFjZWhvbGRlcicpIGZpbHRlclBsYWNlaG9sZGVyOiBzdHJpbmc7XHJcblxyXG4gIEBJbnB1dCgnY2xzLXNlbGVjdCcpIGNsc1NlbGVjdDogc3RyaW5nO1xyXG4gIEBJbnB1dCgnY2xzLXByZXBlbmQnKSBjbHNQcmVwZW5kOiBzdHJpbmc7XHJcbiAgQElucHV0KCdjbHMtYXBwZW5kJykgY2xzQXBwZW5kOiBzdHJpbmc7XHJcbiAgQElucHV0KCdjbHMtb3B0aW9uJykgY2xzT3B0aW9uOiBzdHJpbmc7XHJcbiAgQElucHV0KCdjbHMtb3B0aW9uLWdyb3VwJykgY2xzT3B0aW9uR3JvdXA6IHN0cmluZztcclxuICBASW5wdXQoJ2Nscy1kcm9wLWxpc3QnKSBjbHNEcm9wTGlzdDogc3RyaW5nO1xyXG4gIEBJbnB1dCgnY2xzLXNlbGVjdGVkLWl0ZW0nKSBjbHNTZWxlY3RlZEl0ZW06IHN0cmluZztcclxuICBASW5wdXQoJ2Nscy1zZWxlY3RlZC1pdGVtLXJlbW92ZXInKSBjbHNTZWxlY3RlZEl0ZW1SZW1vdmVyOiBzdHJpbmc7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ2lucHV0JywgeyBzdGF0aWM6IHRydWUgfSkgcHJpdmF0ZSBpbnB1dDogRWxlbWVudFJlZjtcclxuICBwcml2YXRlIHNlbGVjdDogYW55O1xyXG4gIHByaXZhdGUgY2xvbmVkRWxlbWVudDogYW55O1xyXG5cclxuICBjcmVhdGVDb250cm9sKCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChjb21wbGV0ZSkgPT4ge1xyXG4gICAgICBjb25zdCBvcmlnaW5hbEVsZW1lbnQgPSAkKHRoaXMuaW5wdXQubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgIE9iamVjdEhlbHBlci5oaWRlKG9yaWdpbmFsRWxlbWVudCk7XHJcblxyXG4gICAgICBpZiAodGhpcy5jbG9uZWRFbGVtZW50KSB7XHJcbiAgICAgICAgdGhpcy5jbG9uZWRFbGVtZW50LmNoaWxkcmVuKCkuYXBwZW5kVG8ob3JpZ2luYWxFbGVtZW50KTtcclxuICAgICAgICB0aGlzLmNsb25lZEVsZW1lbnQucGFyZW50KCkucmVtb3ZlKCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuY2xvbmVkRWxlbWVudCA9IG9yaWdpbmFsRWxlbWVudC5jbG9uZSgpO1xyXG4gICAgICBPYmplY3RIZWxwZXIuc2hvdyh0aGlzLmNsb25lZEVsZW1lbnQpO1xyXG4gICAgICBvcmlnaW5hbEVsZW1lbnQucGFyZW50KCkuYXBwZW5kKHRoaXMuY2xvbmVkRWxlbWVudCk7XHJcblxyXG4gICAgICBvcmlnaW5hbEVsZW1lbnQuY2hpbGRyZW4oKS5hcHBlbmRUbyh0aGlzLmNsb25lZEVsZW1lbnQpO1xyXG4gICAgICB0aGlzLnNlbGVjdCA9IHRoaXMuY2xvbmVkRWxlbWVudC5zZWxlY3QoKS5kYXRhKCdzZWxlY3QnKTtcclxuXHJcbiAgICAgIHRoaXMuY2xvbmVkRWxlbWVudC5wYXJlbnQoKS5vbignbW91c2Vkb3duJywgKGV2OiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgaWYgKGV2LmJ1dHRvbiA9PT0gMCkge1xyXG4gICAgICAgICAgdGhpcy50b3VjaENhbGxiYWNrKCk7XHJcbiAgICAgICAgICB0aGlzLmNsb25lZEVsZW1lbnQucGFyZW50KCkub2ZmKCdtb3VzZWRvd24nKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdGhpcy5zZWxlY3Qub3B0aW9ucy5vbkNoYW5nZSA9ICh2YWwpID0+IHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgICAgIGNvbnN0IGFsbE9wdGlvbnM6IE9wdGlvbltdID0gW107XHJcblxyXG4gICAgICAgICAgdGhpcy5vcHRpb25zLmZvckVhY2goKG9wdGlvbjogT3B0aW9uICB8IHsgb3B0aW9uczogT3B0aW9uW10gfSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoISEoPGFueT5vcHRpb24pLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAoPGFueT5vcHRpb24pLm9wdGlvbnMuZm9yRWFjaCgoc3ViT3B0aW9uOiBPcHRpb24pID0+IHtcclxuICAgICAgICAgICAgICAgIGFsbE9wdGlvbnMucHVzaChzdWJPcHRpb24pO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIGFsbE9wdGlvbnMucHVzaCg8T3B0aW9uPm9wdGlvbik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgIHZhbCA9IHZhbC5tYXAoa2V5ID0+IGFsbE9wdGlvbnMuZmluZChvcHRpb24gPT4gU3RyaW5nSGVscGVyLmNyZWF0ZUhhc2gob3B0aW9uLnZhbHVlKSA9PT0ga2V5KSkuZmlsdGVyKHYgPT4gISF2KS5tYXAodiA9PiB2LnZhbHVlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLm11bHRpcGxlKSB7XHJcbiAgICAgICAgICB0aGlzLmNoYW5nZVZhbHVlKHZhbC5zbGljZSgwKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMuY2hhbmdlVmFsdWUodmFsWzBdKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcblxyXG4gICAgICBpZiAodGhpcy5vcHRpb25zICYmICEodGhpcy5vcHRpb25zIGluc3RhbmNlb2YgQXJyYXkpKSB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3QuZGF0YSh0aGlzLm9wdGlvbnMpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb21wbGV0ZSgpO1xyXG4gICAgfSk7XHJcblxyXG4gIH1cclxuXHJcbiAgZGlzYWJsZShkaXNhYmxlZDogYm9vbGVhbikge1xyXG4gICAgaWYgKGRpc2FibGVkKSB7XHJcbiAgICAgIHRoaXMuc2VsZWN0LmRpc2FibGUoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuc2VsZWN0LmVuYWJsZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmV3VmFsdWUoKSB7XHJcbiAgICBpZiAoIXRoaXMuc2VsZWN0KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgc2VsZWN0VmFsdWU6IGFueVtdID0gdGhpcy5tdWx0aXBsZSA/IDxhbnlbXT50aGlzLmlubmVyVmFsdWUgOiBbIHRoaXMuaW5uZXJWYWx1ZSBdO1xyXG5cclxuICAgIGlmICh0aGlzLm9wdGlvbnMgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICBzZWxlY3RWYWx1ZSA9IHNlbGVjdFZhbHVlLm1hcCh2ID0+IFN0cmluZ0hlbHBlci5jcmVhdGVIYXNoKHYpKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5tdWx0aXBsZSkge1xyXG4gICAgICB0aGlzLnNlbGVjdC5yZXNldCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuc2VsZWN0LnZhbChzZWxlY3RWYWx1ZSk7XHJcbiAgfVxyXG5cclxuICBuZXdDbGFzc1ZhbHVlKG5ld0NsYXNzZXM6IHN0cmluZ1tdLCBvbGRDbGFzc2VzOiBzdHJpbmdbXSkge1xyXG4gICAgYXNhcFNjaGVkdWxlci5zY2hlZHVsZSgoKSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLmNsb25lZEVsZW1lbnQpIHtcclxuICAgICAgICBjb25zdCB0YXJnZXQgPSB0aGlzLmNsb25lZEVsZW1lbnQucGFyZW50KCk7XHJcblxyXG4gICAgICAgIG9sZENsYXNzZXMuZm9yRWFjaCgoY2xzOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgIHRhcmdldC5yZW1vdmVDbGFzcyhjbHMpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBuZXdDbGFzc2VzLmZvckVhY2goKGNsczogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICB0YXJnZXQuYWRkQ2xhc3MoY2xzKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSwgMSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==