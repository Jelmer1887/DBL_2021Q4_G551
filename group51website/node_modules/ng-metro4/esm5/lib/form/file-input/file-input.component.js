import { __decorate, __extends, __metadata } from "tslib";
import { ChangeDetectionStrategy, Component, ElementRef, Input, ViewChild, ViewEncapsulation } from '@angular/core';
import { ControlBase } from '../control-base';
import { DefaultValueAccessor } from '../../helper/default-value-accessor';
import { TypeAlias } from '../../helper/type-alias';
import { ObjectHelper } from '../../helper/object-helper';
var FileInputComponent = /** @class */ (function (_super) {
    __extends(FileInputComponent, _super);
    function FileInputComponent() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.multiple = false;
        _this.accept = '';
        _this.read = '';
        _this.drop = false;
        return _this;
    }
    FileInputComponent_1 = FileInputComponent;
    FileInputComponent.prototype.createControl = function () {
        var _this = this;
        return new Promise(function (complete) {
            var originalElement = $(_this.input.nativeElement);
            ObjectHelper.hide(originalElement);
            if (_this.clonedElement) {
                _this.clonedElement.parent().remove();
            }
            _this.clonedElement = originalElement.clone();
            ObjectHelper.show(_this.clonedElement);
            originalElement.parent().append(_this.clonedElement);
            _this.fileInput = _this.clonedElement.file().data('file');
            if (_this.drop) {
                if (_this.buttonTitle) {
                    var captionElement = _this.clonedElement.closest('label.drop-zone').find('span.caption');
                    captionElement.html(_this.buttonTitle);
                }
                if (_this.infoText) {
                    _this.updateInfoText();
                }
            }
            _this.fileInput.options.onSelect = function (files) {
                if (_this.multiple) {
                    var result = [];
                    for (var i = 0; i < files.length; i++) {
                        result.push(files[i]);
                    }
                    if (_this.read) {
                        _this.readFiles(files);
                    }
                    else {
                        _this.changeValue(result);
                    }
                }
                else {
                    if (_this.read) {
                        _this.readFiles(files);
                    }
                    else {
                        _this.changeValue(files[0]);
                    }
                }
                if (_this.drop && _this.infoText) {
                    _this.updateInfoText();
                }
            };
            _this.clonedElement.one('blur', function () {
                _this.touchCallback();
            });
            complete();
        });
    };
    FileInputComponent.prototype.readFiles = function (files) {
        var _this = this;
        var fileLoadPromises = [];
        var _loop_1 = function (i) {
            var file = files[i];
            var loadPromise = new Promise(function (resolve) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    resolve({ content: reader.result, file: file });
                };
                switch (_this.read) {
                    case 'arrayBuffer':
                        reader.readAsArrayBuffer(file);
                        break;
                    case 'binaryString':
                        reader.readAsBinaryString(file);
                        break;
                    case 'dataUrl':
                        reader.readAsDataURL(file);
                        break;
                    case 'text':
                    default:
                        reader.readAsText(file);
                        break;
                }
            });
            fileLoadPromises.push(loadPromise);
        };
        for (var i = 0; i < files.length; i++) {
            _loop_1(i);
        }
        Promise.all(fileLoadPromises).then(function (fileEntries) {
            if (_this.multiple) {
                _this.changeValue(fileEntries);
            }
            else {
                _this.changeValue(fileEntries[0]);
            }
        });
    };
    FileInputComponent.prototype.disable = function (disabled) {
        if (disabled) {
            this.fileInput.disable();
        }
        else {
            this.fileInput.enable();
        }
    };
    FileInputComponent.prototype.newValue = function () {
        if (!this.fileInput || this.drop || this.read || !this.innerValue) {
            return;
        }
        var name;
        if (this.innerValue instanceof Array) {
            name = this.innerValue.map(function (v) {
                if (v instanceof File) {
                    return v.name;
                }
                else {
                    return v.file.name;
                }
            }).join(', ');
        }
        else {
            name = this.innerValue instanceof File ? this.innerValue.name : this.innerValue.file.name;
        }
        this.clonedElement.parent().find('span.caption').html(name);
    };
    FileInputComponent.prototype.newClassValue = function (newClasses, oldClasses) {
        if (this.clonedElement) {
            var target_1 = this.clonedElement.parent();
            oldClasses.forEach(function (cls) {
                target_1.removeClass(cls);
            });
            newClasses.forEach(function (cls) {
                target_1.addClass(cls);
            });
        }
    };
    FileInputComponent.prototype.updateInfoText = function () {
        var infoTextContent = this.infoText
            .split('{0}')
            .join(this.innerValue instanceof Array ? "" + this.innerValue.length : this.innerValue ? '1' : '0');
        var infoTextElement = this.clonedElement.closest('label.drop-zone').find('span.files');
        infoTextElement.html(infoTextContent);
    };
    var FileInputComponent_1;
    __decorate([
        Input('multiple'),
        __metadata("design:type", Object)
    ], FileInputComponent.prototype, "multiple", void 0);
    __decorate([
        Input('accept'),
        __metadata("design:type", Object)
    ], FileInputComponent.prototype, "accept", void 0);
    __decorate([
        Input('read'),
        __metadata("design:type", String)
    ], FileInputComponent.prototype, "read", void 0);
    __decorate([
        Input('prepend'),
        __metadata("design:type", String)
    ], FileInputComponent.prototype, "prepend", void 0);
    __decorate([
        Input('button-title'),
        __metadata("design:type", String)
    ], FileInputComponent.prototype, "buttonTitle", void 0);
    __decorate([
        Input('info-text'),
        __metadata("design:type", String)
    ], FileInputComponent.prototype, "infoText", void 0);
    __decorate([
        Input('drop'),
        __metadata("design:type", Object)
    ], FileInputComponent.prototype, "drop", void 0);
    __decorate([
        Input('cls-component'),
        __metadata("design:type", String)
    ], FileInputComponent.prototype, "clsComponent", void 0);
    __decorate([
        Input('cls-caption'),
        __metadata("design:type", String)
    ], FileInputComponent.prototype, "clsCaption", void 0);
    __decorate([
        Input('cls-prepend'),
        __metadata("design:type", String)
    ], FileInputComponent.prototype, "clsPrepend", void 0);
    __decorate([
        Input('cls-button'),
        __metadata("design:type", String)
    ], FileInputComponent.prototype, "clsButton", void 0);
    __decorate([
        ViewChild('input', { static: true }),
        __metadata("design:type", ElementRef)
    ], FileInputComponent.prototype, "input", void 0);
    FileInputComponent = FileInputComponent_1 = __decorate([
        Component({
            selector: 'm4-file-input',
            template: "<input type=\"file\" #input\r\n\r\n\r\n       [accept]=\"accept\"\r\n       [multiple]=\"multiple\"\r\n       [attr.data-prepend]=\"prepend\"\r\n       [attr.data-button-title]=\"buttonTitle\"\r\n       [attr.data-mode]=\"drop === true ? 'drop' : null\"\r\n\r\n       [attr.data-cls-component]=\"clsComponent\"\r\n       [attr.data-cls-caption]=\"clsCaption\"\r\n       [attr.data-cls-prepend]=\"clsPrepend\"\r\n       [attr.data-cls-button]=\"clsButton\">\r\n",
            providers: [DefaultValueAccessor.get(FileInputComponent_1), TypeAlias.get(FileInputComponent_1)],
            changeDetection: ChangeDetectionStrategy.OnPush,
            encapsulation: ViewEncapsulation.None,
            styles: [".drop-zone.primary{outline-color:#0366d6}.drop-zone.secondary{outline-color:#607d8b}.drop-zone.success{outline-color:#60a917}.drop-zone.alert{outline-color:#ce352c}.drop-zone.warning{outline-color:#ff9447}.drop-zone.yellow{outline-color:#ffe484}.drop-zone.info{outline-color:#5ebdec}.drop-zone.dark{outline-color:#505050}.drop-zone.light{outline-color:#f8f8f8}"]
        })
    ], FileInputComponent);
    return FileInputComponent;
}(ControlBase));
export { FileInputComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1pbnB1dC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1tZXRybzQvIiwic291cmNlcyI6WyJsaWIvZm9ybS9maWxlLWlucHV0L2ZpbGUtaW5wdXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2xILE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUN6RSxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDbEQsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLDRCQUE0QixDQUFDO0FBa0J4RDtJQUF3QyxzQ0FBb0Q7SUFBNUY7UUFBQSxxRUFnTEM7UUE5S29CLGNBQVEsR0FBRyxLQUFLLENBQUM7UUFDbkIsWUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNkLFVBQUksR0FBcUIsRUFBRSxDQUFDO1FBSzVCLFVBQUksR0FBRyxLQUFLLENBQUM7O0lBdUs5QixDQUFDOzJCQWhMWSxrQkFBa0I7SUFvQjdCLDBDQUFhLEdBQWI7UUFBQSxpQkEyREM7UUExREMsT0FBTyxJQUFJLE9BQU8sQ0FBTyxVQUFDLFFBQVE7WUFDaEMsSUFBTSxlQUFlLEdBQUcsQ0FBQyxDQUFDLEtBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDcEQsWUFBWSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUVuQyxJQUFJLEtBQUksQ0FBQyxhQUFhLEVBQUU7Z0JBQ3RCLEtBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDdEM7WUFFRCxLQUFJLENBQUMsYUFBYSxHQUFHLGVBQWUsQ0FBQyxL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WUFDVCxRQUFRLEVBQUUsZUFBZTtZQUN6Qix3ZEFBMEM7WUFFMUMsU0FBUyxFQUFFLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLG9CQUFrQixDQUFDLEVBQUUsU0FBUyxDQUFDLEdBQUcsQ0FBQyxvQkFBa0IsQ0FBQyxDQUFDO1lBQzVGLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO1lBQy9DLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJOztTQUN0QyxDQUFDO09BQ1csa0JBQWtCLENBZ0w5QjtJQUFELHlCQUFDO0NBQUEsQUFoTEQsQ0FBd0MsV0FBVyxHQWdMbEQ7U0FoTFksa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBJbnB1dCwgVmlld0NoaWxkLCBWaWV3RW5jYXBzdWxhdGlvbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7Q29udHJvbEJhc2V9IGZyb20gJy4uL2NvbnRyb2wtYmFzZSc7XHJcbmltcG9ydCB7RGVmYXVsdFZhbHVlQWNjZXNzb3J9IGZyb20gJy4uLy4uL2hlbHBlci9kZWZhdWx0LXZhbHVlLWFjY2Vzc29yJztcclxuaW1wb3J0IHtUeXBlQWxpYXN9IGZyb20gJy4uLy4uL2hlbHBlci90eXBlLWFsaWFzJztcclxuaW1wb3J0IHtPYmplY3RIZWxwZXJ9IGZyb20gJy4uLy4uL2hlbHBlci9vYmplY3QtaGVscGVyJztcclxuaW1wb3J0IHtGaWxlUmVhZE1vZGVUeXBlfSBmcm9tICcuLi8uLi9oZWxwZXIvdHlwZXMnO1xyXG5cclxuZGVjbGFyZSB2YXIgJDogYW55O1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGaWxlRW50cnkge1xyXG4gIGZpbGU6IEZpbGU7XHJcbiAgY29udGVudDogYW55O1xyXG59XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ200LWZpbGUtaW5wdXQnLFxyXG4gIHRlbXBsYXRlVXJsOiAnLi9maWxlLWlucHV0LmNvbXBvbmVudC5odG1sJyxcclxuICBzdHlsZVVybHM6IFsnLi9maWxlLWlucHV0LmNvbXBvbmVudC5sZXNzJ10sXHJcbiAgcHJvdmlkZXJzOiBbRGVmYXVsdFZhbHVlQWNjZXNzb3IuZ2V0KEZpbGVJbnB1dENvbXBvbmVudCksIFR5cGVBbGlhcy5nZXQoRmlsZUlucHV0Q29tcG9uZW50KV0sXHJcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXHJcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxyXG59KVxyXG5leHBvcnQgY2xhc3MgRmlsZUlucHV0Q29tcG9uZW50IGV4dGVuZHMgQ29udHJvbEJhc2U8RmlsZSB8IEZpbGVbXSB8IEZpbGVFbnRyeSB8IEZpbGVFbnRyeVtdPiB7XHJcblxyXG4gIEBJbnB1dCgnbXVsdGlwbGUnKSBtdWx0aXBsZSA9IGZhbHNlO1xyXG4gIEBJbnB1dCgnYWNjZXB0JykgYWNjZXB0ID0gJyc7XHJcbiAgQElucHV0KCdyZWFkJykgcmVhZDogRmlsZVJlYWRNb2RlVHlwZSA9ICcnO1xyXG5cclxuICBASW5wdXQoJ3ByZXBlbmQnKSBwcmVwZW5kOiBzdHJpbmc7XHJcbiAgQElucHV0KCdidXR0b24tdGl0bGUnKSBidXR0b25UaXRsZTogc3RyaW5nO1xyXG4gIEBJbnB1dCgnaW5mby10ZXh0JykgaW5mb1RleHQ6IHN0cmluZztcclxuICBASW5wdXQoJ2Ryb3AnKSBkcm9wID0gZmFsc2U7XHJcblxyXG4gIEBJbnB1dCgnY2xzLWNvbXBvbmVudCcpIGNsc0NvbXBvbmVudDogc3RyaW5nO1xyXG4gIEBJbnB1dCgnY2xzLWNhcHRpb24nKSBjbHNDYXB0aW9uOiBzdHJpbmc7XHJcbiAgQElucHV0KCdjbHMtcHJlcGVuZCcpIGNsc1ByZXBlbmQ6IHN0cmluZztcclxuICBASW5wdXQoJ2Nscy1idXR0b24nKSBjbHNCdXR0b246IHN0cmluZztcclxuXHJcbiAgQFZpZXdDaGlsZCgnaW5wdXQnLCB7c3RhdGljOiB0cnVlfSkgcHJpdmF0ZSBpbnB1dDogRWxlbWVudFJlZjtcclxuICBwcml2YXRlIGZpbGVJbnB1dDogYW55O1xyXG4gIHByaXZhdGUgY2xvbmVkRWxlbWVudDogYW55O1xyXG5cclxuICBjcmVhdGVDb250cm9sKCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChjb21wbGV0ZSkgPT4ge1xyXG4gICAgICBjb25zdCBvcmlnaW5hbEVsZW1lbnQgPSAkKHRoaXMuaW5wdXQubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgIE9iamVjdEhlbHBlci5oaWRlKG9yaWdpbmFsRWxlbWVudCk7XHJcblxyXG4gICAgICBpZiAodGhpcy5jbG9uZWRFbGVtZW50KSB7XHJcbiAgICAgICAgdGhpcy5jbG9uZWRFbGVtZW50LnBhcmVudCgpLnJlbW92ZSgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmNsb25lZEVsZW1lbnQgPSBvcmlnaW5hbEVsZW1lbnQuY2xvbmUoKTtcclxuICAgICAgT2JqZWN0SGVscGVyLnNob3codGhpcy5jbG9uZWRFbGVtZW50KTtcclxuICAgICAgb3JpZ2luYWxFbGVtZW50LnBhcmVudCgpLmFwcGVuZCh0aGlzLmNsb25lZEVsZW1lbnQpO1xyXG5cclxuICAgICAgdGhpcy5maWxlSW5wdXQgPSB0aGlzLmNsb25lZEVsZW1lbnQuZmlsZSgpLmRhdGEoJ2ZpbGUnKTtcclxuXHJcbiAgICAgIGlmICh0aGlzLmRyb3ApIHtcclxuICAgICAgICBpZiAodGhpcy5idXR0b25UaXRsZSkge1xyXG4gICAgICAgICAgY29uc3QgY2FwdGlvbkVsZW1lbnQgPSB0aGlzLmNsb25lZEVsZW1lbnQuY2xvc2VzdCgnbGFiZWwuZHJvcC16b25lJykuZmluZCgnc3Bhbi5jYXB0aW9uJyk7XHJcbiAgICAgICAgICBjYXB0aW9uRWxlbWVudC5odG1sKHRoaXMuYnV0dG9uVGl0bGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5mb1RleHQpIHtcclxuICAgICAgICAgIHRoaXMudXBkYXRlSW5mb1RleHQoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuZmlsZUlucHV0Lm9wdGlvbnMub25TZWxlY3QgPSAoZmlsZXMpID0+IHtcclxuICAgICAgICBpZiAodGhpcy5tdWx0aXBsZSkge1xyXG4gICAgICAgICAgY29uc3QgcmVzdWx0OiBGaWxlW10gPSBbXTtcclxuXHJcbiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGZpbGVzW2ldKTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBpZiAodGhpcy5yZWFkKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVhZEZpbGVzKGZpbGVzKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlVmFsdWUocmVzdWx0KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaWYgKHRoaXMucmVhZCkge1xyXG4gICAgICAgICAgICB0aGlzLnJlYWRGaWxlcyhmaWxlcyk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmNoYW5nZVZhbHVlKGZpbGVzWzBdKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmRyb3AgJiYgdGhpcy5pbmZvVGV4dCkge1xyXG4gICAgICAgICAgdGhpcy51cGRhdGVJbmZvVGV4dCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuXHJcbiAgICAgIHRoaXMuY2xvbmVkRWxlbWVudC5vbmUoJ2JsdXInLCAoKSA9PiB7XHJcbiAgICAgICAgdGhpcy50b3VjaENhbGxiYWNrKCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29tcGxldGUoKTtcclxuICAgIH0pO1xyXG5cclxuICB9XHJcblxyXG4gIHJlYWRGaWxlcyhmaWxlczogRmlsZVtdKSB7XHJcbiAgICBjb25zdCBmaWxlTG9hZFByb21pc2VzID0gW107XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWxlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBjb25zdCBmaWxlID0gZmlsZXNbaV07XHJcblxyXG4gICAgICBjb25zdCBsb2FkUHJvbWlzZSA9IG5ldyBQcm9taXNlPEZpbGVFbnRyeT4oKHJlc29sdmUpID0+IHtcclxuICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG5cclxuICAgICAgICByZWFkZXIub25sb2FkID0gKGUpID0+IHtcclxuICAgICAgICAgIHJlc29sdmUoe2NvbnRlbnQ6IHJlYWRlci5yZXN1bHQsIGZpbGU6IGZpbGV9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBzd2l0Y2ggKHRoaXMucmVhZCkge1xyXG4gICAgICAgICAgY2FzZSAnYXJyYXlCdWZmZXInOlxyXG4gICAgICAgICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoZmlsZSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgY2FzZSAnYmluYXJ5U3RyaW5nJzpcclxuICAgICAgICAgICAgcmVhZGVyLnJlYWRBc0JpbmFyeVN0cmluZyhmaWxlKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICBjYXNlICdkYXRhVXJsJzpcclxuICAgICAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgY2FzZSAndGV4dCc6XHJcbiAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICByZWFkZXIucmVhZEFzVGV4dChmaWxlKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGZpbGVMb2FkUHJvbWlzZXMucHVzaChsb2FkUHJvbWlzZSk7XHJcbiAgICB9XHJcblxyXG4gICAgUHJvbWlzZS5hbGwoZmlsZUxvYWRQcm9taXNlcykudGhlbigoZmlsZUVudHJpZXM6IEZpbGVFbnRyeVtdKSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLm11bHRpcGxlKSB7XHJcbiAgICAgICAgdGhpcy5jaGFuZ2VWYWx1ZShmaWxlRW50cmllcyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5jaGFuZ2VWYWx1ZShmaWxlRW50cmllc1swXSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZGlzYWJsZShkaXNhYmxlZDogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgaWYgKGRpc2FibGVkKSB7XHJcbiAgICAgIHRoaXMuZmlsZUlucHV0LmRpc2FibGUoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuZmlsZUlucHV0LmVuYWJsZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmV3VmFsdWUoKTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMuZmlsZUlucHV0IHx8IHRoaXMuZHJvcCB8fCB0aGlzLnJlYWQgfHwgIXRoaXMuaW5uZXJWYWx1ZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IG5hbWU7XHJcblxyXG4gICAgaWYgKHRoaXMuaW5uZXJWYWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgIG5hbWUgPSAoPGFueT50aGlzLmlubmVyVmFsdWUpLm1hcCgodjogRmlsZSB8IEZpbGVFbnRyeSkgPT4ge1xyXG4gICAgICAgIGlmICh2IGluc3RhbmNlb2YgRmlsZSkge1xyXG4gICAgICAgICAgcmV0dXJuIHYubmFtZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIHYuZmlsZS5uYW1lO1xyXG4gICAgICAgIH1cclxuICAgICAgfSkuam9pbignLCAnKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG5hbWUgPSB0aGlzLmlubmVyVmFsdWUgaW5zdGFuY2VvZiBGaWxlID8gdGhpcy5pbm5lclZhbHVlLm5hbWUgOiB0aGlzLmlubmVyVmFsdWUuZmlsZS5uYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuY2xvbmVkRWxlbWVudC5wYXJlbnQoKS5maW5kKCdzcGFuLmNhcHRpb24nKS5odG1sKG5hbWUpO1xyXG4gIH1cclxuXHJcbiAgbmV3Q2xhc3NWYWx1ZShuZXdDbGFzc2VzOiBzdHJpbmdbXSwgb2xkQ2xhc3Nlczogc3RyaW5nW10pIHtcclxuICAgIGlmICh0aGlzLmNsb25lZEVsZW1lbnQpIHtcclxuICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5jbG9uZWRFbGVtZW50LnBhcmVudCgpO1xyXG5cclxuICAgICAgb2xkQ2xhc3Nlcy5mb3JFYWNoKChjbHM6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIHRhcmdldC5yZW1vdmVDbGFzcyhjbHMpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIG5ld0NsYXNzZXMuZm9yRWFjaCgoY2xzOiBzdHJpbmcpID0+IHtcclxuICAgICAgICB0YXJnZXQuYWRkQ2xhc3MoY2xzKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZUluZm9UZXh0KCkge1xyXG4gICAgY29uc3QgaW5mb1RleHRDb250ZW50ID0gdGhpcy5pbmZvVGV4dFxyXG4gICAgICAuc3BsaXQoJ3swfScpXHJcbiAgICAgIC5qb2luKHRoaXMuaW5uZXJWYWx1ZSBpbnN0YW5jZW9mIEFycmF5ID8gYCR7dGhpcy5pbm5lclZhbHVlLmxlbmd0aH1gIDogdGhpcy5pbm5lclZhbHVlID8gJzEnIDogJzAnKTtcclxuXHJcbiAgICBjb25zdCBpbmZvVGV4dEVsZW1lbnQgPSB0aGlzLmNsb25lZEVsZW1lbnQuY2xvc2VzdCgnbGFiZWwuZHJvcC16b25lJykuZmluZCgnc3Bhbi5maWxlcycpO1xyXG4gICAgaW5mb1RleHRFbGVtZW50Lmh0bWwoaW5mb1RleHRDb250ZW50KTtcclxuICB9XHJcblxyXG59XHJcbiJdfQ==